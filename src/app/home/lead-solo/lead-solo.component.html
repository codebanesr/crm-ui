<nz-content class="parent">
  <div class="top">    
    <ng-container *ngIf="leadFilter">
      <!-- <nz-tag *ngFor="let key of objectkeys(leadFilter);" nzMode='closeable' (nzOnClose)="handleTagRemoval(key)"
        [nzColor]="'magenta'">
        {{typeDict[key].label}} :
        {{typeDict[key].type === 'date' ? ((leadFilter[key][0]|date)+" to "+(leadFilter[key][1]|date)): leadFilter[key]}}
      </nz-tag> -->

        <mat-chip-list #chipList aria-label="Fruit selection">
          <mat-chip
            *ngFor="let key of objectkeys(leadFilter);"
            [selectable]="true"
            [removable]="true"
            (removed)="handleTagRemoval(key)">
            {{typeDict[key].label}} :
            {{typeDict[key].type === 'date' ? ((leadFilter[key][0]|date)+" to "+(leadFilter[key][1]|date)): leadFilter[key]}}
            <mat-icon matChipRemove>x</mat-icon>
          </mat-chip>
        </mat-chip-list>
      
    </ng-container>
  </div>

  <nz-empty *ngIf="isEmpty(selectedLead)"></nz-empty>
  <nz-page-header class="site-page-header" *ngIf="selectedLead">
    <nz-page-header-title>{{selectedLead.firstName}} {{selectedLead.lastName}}</nz-page-header-title>
    <!-- <nz-page-header-subtitle >{{selectedLead.lastName}}</nz-page-header-subtitle> -->
    <nz-page-header-content>
      <div class="content">
        <div class="main">
          <ng-container>
            <mat-accordion>
              <mat-expansion-panel hideToggle>

                <mat-expansion-panel-header>
                  <mat-panel-title style="font-weight: 500; font-size: 1.1rem;">
                    Lead Information
                  </mat-panel-title>
                </mat-expansion-panel-header>

                <mat-tab-group>
                  <mat-tab [label]="g.label" *ngFor="let g of leadGroups">
                    <div style="height: 10px;"></div>
                    <ng-container *ngFor="let leadKey of objectkeys(selectedLead)" key="leadKey">
                      <ng-container *ngIf="g.value.includes(leadKey)">
                        <mat-form-field class="example-full-width" appearance="outline" *ngIf="['date', 'option', 'string', 'tel'].includes(typeDict[leadKey].type)">
                            <mat-label>{{typeDict[leadKey].label}}</mat-label>
                          
                            <input matInput [(ngModel)]="selectedLead[leadKey]" [disabled]="isDisabled(leadKey)" *ngIf="typeDict[leadKey].type === 'string'"/>
                            <input matInput type="tel" [(ngModel)]="selectedLead[leadKey]" [disabled]="isDisabled(leadKey)" *ngIf="typeDict[leadKey].type === 'tel'"/>
                            
                            <ng-container *ngIf="typeDict[leadKey].type === 'date'">
                              <input matInput [matDatepicker]="picker" [(ngModel)]="selectedLead[leadKey]" [disabled]="isDisabled(leadKey)"/>
                              <mat-datepicker #picker color="primary"></mat-datepicker>
                              <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                            </ng-container>
                          
                            <mat-select [(ngModel)]="selectedLead[leadKey]" *ngIf="typeDict[leadKey].type === 'select'">
                              <mat-option *ngFor="let option of typeDict[leadKey].options" [value]="option">{{option}}
                              </mat-option>
                            </mat-select>
                          
                        </mat-form-field>
                      </ng-container>
                    </ng-container>

                  </mat-tab>
                </mat-tab-group>
              </mat-expansion-panel>
            </mat-accordion>
            <mat-card>
              <ng-container *ngFor="let key of contactGroup?.value">
                <div *ngIf="isMobile(selectedLead[key])">
                  <button style="margin-bottom: 2px; margin-right: 4px;" mat-button color="primary" mat-flat-button (click)="onPhoneClick(selectedLead[key])" >
                    <ion-icon name="call"></ion-icon>
                    <i class="icon ion-ios-telephone"></i> &nbsp;
                    {{selectedLead[key]}}
                  </button>

                  <a [href]="getSafeWhatsAppUrl(selectedLead[key])" mat-raised-button mat-icon-button><ion-icon style="font-size: 1.3rem;font-weight: 800;" name="logo-whatsapp"></ion-icon></a>
                </div>
                <!-- <div *ngIf="isEmail(selectedLead[key])">
                  <button mat-raised-button><ion-icon name="mail-outline"></ion-icon> {{selectedLead[key]}} </button>
                </div> -->
              </ng-container>
            </mat-card>

            <mat-expansion-panel>
              <mat-expansion-panel-header>Dispositions</mat-expansion-panel-header>
              <nz-tree [nzData]="callDispositions" (nzClick)="handleDispositionTreeEvent($event)"  *ngIf="callDispositions">
              </nz-tree>
            </mat-expansion-panel>

            <mat-expansion-panel>
              <mat-expansion-panel-header>Upload Documents</mat-expansion-panel-header>
              <a [href]="link" *ngFor="let link of selectedLead.documentLinks" style="display: block;">{{link}}</a>
              <a [href]="link" *ngFor="let link of uploadedDocsLink" style="display: block;">{{link}}</a>
              <!-- <img [src]="link" *ngFor="let link of selectedLead.documentLinks" style="height: 200px; width: 200px;"> -->
              <div class="clearfix">
                <ion-fab vertical="bottom" horizontal="end" slot="fixed">
                  <input
                    type="file"
                    #fileInput
                    (change)="handleDocumentUpload($event.target.files[0])"
                    hidden="true"
                    accept="image/*"
                  />
                  <ion-fab-button (click)="selectImageSource()">
                    <ion-icon name="add"></ion-icon>
                  </ion-fab-button>
                </ion-fab>
              </div>

            </mat-expansion-panel>

            <mat-expansion-panel>

              <mat-expansion-panel-header>
                <mat-panel-title>
                  Followup
                </mat-panel-title>
              </mat-expansion-panel-header>

              <mat-form-field class="example-full-width" appearance="fill">
                <mat-label>Choose an option</mat-label>
                <mat-select [(ngModel)]="selectedLead.nextAction">
                  <mat-option value="followUp">Follow Up</mat-option>
                  <mat-option value="onSite">On Site</mat-option>
                  <mat-option value="salesCall">Sales Call</mat-option>
                </mat-select>
              </mat-form-field>

              <p style="font-weight: 700;">{{selectedLead.followUp | date: 'short'}}&nbsp;<i nz-icon nzType="down"></i>
              </p>
              <mat-form-field class="example-full-width" appearance="fill">
                <mat-label>Follow Up</mat-label>
                <mat-select (selectionChange)="handleFollowUp($event)">
                  <mat-option value="1">Now</mat-option>
                  <mat-option value="2">After 10 minutes</mat-option>
                  <mat-option value="3">After One Hour</mat-option>
                  <mat-option value="4">Tomorrow</mat-option>
                  <mat-option value="4" (click)="showFollowUpInput=true">Custom</mat-option>
                </mat-select>
              </mat-form-field>
            </mat-expansion-panel>

            <nz-modal [(nzVisible)]="showFollowUpInput" nzTitle="Custom FollowUp" nzOkText="Ok" nzCancelText="cancel"
              (nzOnOk)="showFollowUpInput = false" (nzOnCancel)="showFollowUpInput = false">

              <mat-form-field class="mat-full-width" appearance="outline">
                <input matInput type="datetime-local" id="followUp" [(ngModel)]="selectedLead.followUp" placeholder="followUp" />
              </mat-form-field>
            </nz-modal>

          </ng-container>
          <mat-accordion>
            <mat-expansion-panel *ngIf="selectedLeadHistory?.length>0">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  Lead History
                </mat-panel-title>
              </mat-expansion-panel-header>
              <div style="max-height: 200px; height: 200px; overflow-y: scroll;">
                <WhiteSpace size='lg'></WhiteSpace>
                <ion-fab (click)="onShowMoreClick()" style="position: sticky; float: right; top: 10px;">
                  <ion-fab-button style="transform: scale(0.8);">
                    <ion-icon [name]="historyLimit === 1 ? 'add-outline' : 'remove-outline'"></ion-icon>
                  </ion-fab-button>
                </ion-fab>
                <nz-timeline>
                  <nz-timeline-item nzColor="green"
                    *ngFor="let h of selectedLeadHistory?.reverse().slice(0, historyLimit)">
                    <p>
                      Created at {{h.createdAt | date:"medium"}}
                    </p>
                    <a (click)="openMap(h.geoLocation.coordinates)">Coordinates: {{h.geoLocation.coordinates[0] + ", "+ h.geoLocation.coordinates[1]}}</a>
                    <p style="width: 100%;">{{h.notes}}</p>
                    <p *ngFor="let el of h.requestedInformation" style="background-color: azure;">{{jsonStringify(el)}}
                    </p>
                  </nz-timeline-item>
                </nz-timeline>
              </div>
            </mat-expansion-panel>

            <mat-expansion-panel *ngIf="actions.isInformationRequested">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  Requested Information &nbsp;<i *ngIf="actions.isInformationRequested" style="color: chocolate;"
                    nz-icon nzType="star" nzTheme="fill"></i>
                </mat-panel-title>
              </mat-expansion-panel-header>
              
              <div *ngIf="formModel" style="max-width:500px;">
                <nz-page-header class="site-page-header" nzBackIcon>
                  <nz-page-header-title>{{formModel.name}}</nz-page-header-title>
                  <nz-page-header-subtitle>{{formModel.description}}</nz-page-header-subtitle>
                  <nz-page-header-content>
                    <div class="content">
                      <form nz-form>
                        <ng-container *ngFor="let item of formModel.attributes">
                          <ng-container [ngSwitch]="item.type">

                            <ng-container *ngSwitchCase="'text'">
                              <mat-label nzFor="email">{{item.label}}</mat-label>

                              <input matInput [id]="item.id" [(ngModel)]="item.value" [ngModelOptions]="{standalone: true}"/>

                            </ng-container>

                            <ng-container *ngSwitchCase="'email'">
                              <mat-label>{{item.label}}
                              </mat-label>

                              <input matInput type="email" id="{{item.name}}" [(ngModel)]="item.value" [ngModelOptions]="{standalone: true}"
                                placeholder="{{item.placeholder}}" />

                            </ng-container>

                            <ng-container *ngSwitchCase="'phone'">
                              <mat-label>{{item.label}}
                              </mat-label>

                              <input matInput type="text" id="{{item.name}}" placeholder="{{item.placeholder}}"
                                [(ngModel)]="item.value" [ngModelOptions]="{standalone: true}" />

                            </ng-container>
                            <ng-container *ngSwitchCase="'number'">
                              <mat-label>{{item.label}}</mat-label>

                              <input matInput type="number" id="{{item.name}}" min="{{item.min}}" [(ngModel)]="item.value" [ngModelOptions]="{standalone: true}" max="{{item.max}}" placeholder="{{item.placeholder}}" />

                            </ng-container>
                            <ng-container *ngSwitchCase="'date'">
                              <mat-label>{{item.label}}
                              </mat-label>

                              <input type="datetime-local" matInput id="{{item.name}}" [(ngModel)]="item.value" [ngModelOptions]="{standalone: true}"/>

                            </ng-container>
                            <ng-container *ngSwitchCase="'datetime-local'">
                              <mat-label>{{item.label}}
                              </mat-label>

                              <input type="datetime-local" matInput id="{{item.name}}" nzShowTime
                                [(ngModel)]="item.value" [ngModelOptions]="{standalone: true}" />

                            </ng-container>
                            <ng-container *ngSwitchCase="'textarea'">
                              <mat-label>{{item.label}}</mat-label>

                              <textarea matInput placeholder="Controlled autosize"
                                id="{{item.name}}"
                                placeholder="{{item.placeholder}}" [(ngModel)]="item.value" [ngModelOptions]="{standalone: true}"
                                ></textarea>

                            </ng-container>
                            <ng-container *ngSwitchCase="'file'">
                              <mat-label>{{item.label}} (File
                                can't be uploaded right now)</mat-label>

                              <input matInput type="file" id="{{item.name}}" placeholder="{{item.placeholder}}"
                                [(ngModel)]="item.value" [ngModelOptions]="{standalone: true}" />

                            </ng-container>

                            <div *ngSwitchCase="'paragraph'">
                              <ng-container>
                                <mat-label>{{item.label}}</mat-label>
                                <input matInput type="text" matInput [(ngModel)]="item.value" [ngModelOptions]="{standalone: true}"
                                    placeholder="input with clear icon" [(ngModel)]="item.value" [ngModelOptions]="{standalone: true}"/>
                              </ng-container>
                            </div>
                            <div *ngSwitchCase="'autocomplete'">
                              <ng-container>
                                <mat-label>{{item.label}}</mat-label>

                                <mat-select id="{{item.name}}" [(ngModel)]="item.value" [ngModelOptions]="{standalone: true}">
                                  <mat-option *ngFor="let v of item.values" [value]="v.value"> {{v.label}} </mat-option>
                                </mat-select>
                              </ng-container>
                            </div>
                            <div *ngSwitchCase="'checkbox'">
                              <ng-container>
                                <mat-label>{{item.label}}</mat-label>

                                <!-- <label nz-checkbox *ngFor="let v of item.values" nz-checkbox [(ngModel)]="v.value"
                                  [nzValue]="v.value" >
                                  <span>{{v.label}}</span>
                                </label> -->
                                <mat-checkbox [(ngModel)]="v.value" *ngFor="let v of item.values">
                                  {{v.label}}
                                </mat-checkbox>

                              </ng-container>
                            </div>
                            <ng-container *ngSwitchCase="'radio'">
                              <mat-label>{{item.label}}
                              </mat-label>
                              <mat-radio-group
                                aria-labelledby="molecule-design-radio" [(ngModel)]="item.value">
                                <mat-radio-button class="example-radio-button" *ngFor="let v of item.values" [value]="v.value">
                                  {{v.label}}
                                </mat-radio-button>
                              </mat-radio-group>

                            </ng-container>
                            <ng-container *ngSwitchCase="'button'">

                              <input matInput type="{{item.subtype}}" value="{{item.label}}" id="{{item.name}}"/>

                            </ng-container>
                          </ng-container>
                        </ng-container>
                      </form>
                    </div>
                  </nz-page-header-content>
                </nz-page-header>
              </div>
            </mat-expansion-panel>

            <mat-expansion-panel>
              <mat-expansion-panel-header>
                <mat-panel-title>
                  Send Email
                </mat-panel-title>
              </mat-expansion-panel-header>
              <ng-container>
                <mat-form-field class="example-full-width" appearance="fill">
                  <mat-label>Select Email Template</mat-label>
                  <mat-select (ngModelChange)="populateEmailModal($event)" [(ngModel)]="tempObj">
                    <mat-option [value]="et" *ngFor="let et of emailTemplates">{{ et.templateName }}</mat-option>
                  </mat-select>
                </mat-form-field>
              </ng-container>

              <form nz-form [formGroup]="emailForm" nzLayout="vertical">
                <mat-form-field class="mat-full-width">
                  <mat-label>Subject</mat-label>
                  <input matInput placeholder="Write the subject of email" formControlName="subject" />
                </mat-form-field>

                <mat-form-field class="mat-full-width">
                  <mat-label>Body</mat-label>
                  <textarea matInput placeholder="Controlled autosize"
                    formControlName="content"></textarea>
                </mat-form-field>

                <mat-form-field class="mat-full-width" appearance="fill">
                  <mat-label>Attachments</mat-label>
                  <mat-select multiple formControlName="attachments">
                    <mat-option [value]="attachment" *ngFor="let attachment of attachments">{{ attachment.fileName }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>


                <ng-template #tagPlaceHolder let-selectedList> and {{ selectedList.length }} more selected
                </ng-template>

                <!-- </mat-form-field> -->
              </form>
            </mat-expansion-panel>
          </mat-accordion>


          <div class="mat-button-group">
            <button mat-raised-button (click)="showReassignmentDrawer()" color="warn">Reassign</button>
            <button mat-raised-button (click)="handleLeadSubmission(selectedLead, false)" color="primary">Save</button>
            <button mat-raised-button (click)="handleLeadSubmission(selectedLead, true)" color="accent">Save & Next</button>
          </div>


          <ion-fab vertical="bottom" horizontal="end" slot="fixed" (click)="showFilterDrawer=!showFilterDrawer">
            <ion-fab-button>
              <ion-icon name="filter"></ion-icon>
            </ion-fab-button>
          </ion-fab>
        </div>
      </div>
    </nz-page-header-content>
  </nz-page-header>
</nz-content>


<nz-drawer [nzClosable]="true" [nzVisible]="showFilterDrawer" [nzPlacement]="'right'" nzTitle="Lead Filters"
  (nzOnClose)="closeFilterDrawer()">
  <mat-accordion>
    <mat-expansion-panel>
      <mat-expansion-panel-header>
        Lead Filter
      </mat-expansion-panel-header>
      <ng-container *ngIf="typeDict">
        <ng-container *ngFor="let key of objectkeys(typeDict)">
          <nz-descriptions nzLayout="vertical">
            <nz-descriptions-item *ngIf="typeDict[key]" [nzTitle]="typeDict[key].label">
              <ng-container [ngSwitch]="typeDict[key].type">
                <ng-container *ngSwitchCase="'date'">
                  <!-- <nz-range-picker [nzMode]="dateMode" [(ngModel)]="leadFilter[key]"
                    [ngModelOptions]="{standalone: true}">
                  </nz-range-picker> -->
                  <mat-form-field appearance="outline">
                    <mat-label>Choose a date</mat-label>
                    <input matInput [matDatepicker]="picker"  [(ngModel)]="leadFilter[key]">
                    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                    <mat-datepicker #picker></mat-datepicker>
                  </mat-form-field>
                </ng-container>

                <ng-container *ngSwitchCase="'number'">
                  <input matInput placeholder="Basic usage" [(ngModel)]="leadFilter[key]"
                    [ngModelOptions]="{standalone: true}" />
                </ng-container>

                <ng-container *ngSwitchCase="'string'">
                  <input matInput placeholder="Basic usage" [(ngModel)]="leadFilter[key]"
                    [ngModelOptions]="{standalone: true}" />
                </ng-container>

                <ng-container *ngSwitchCase="'tel'">
                  <input matInput [(ngModel)]="leadFilter[key]" [ngModelOptions]="{standalone: true}" />
                </ng-container>

                <ng-container *ngSwitchCase="'select'">
                  <mat-select [(ngModel)]="leadFilter[key]" [ngModelOptions]="{standalone: true}">
                    <mat-option matInput *ngFor="let option of typeDict[key].options" [value]="option">
                      {{option}}
                    </mat-option>
                  </mat-select>
                </ng-container>
              </ng-container>
            </nz-descriptions-item>
          </nz-descriptions>
        </ng-container>
        <button nz-button (click)="fetchNextLead()">Submit</button>
      </ng-container>
    </mat-expansion-panel>
  </mat-accordion>
</nz-drawer>


<!-- user reassignment drawer -->
<nz-drawer [nzClosable]="false" [nzVisible]="isReassignmentDrawerVisible" nzPlacement="bottom" nzHeight="80vh"
  (nzOnClose)="closeReassignmentDrawer()">
  <h3>Users</h3>
  <mat-selection-list #shoes [multiple]="false">
    <mat-list-option *ngFor="let user of usersForReassignment" (click)="assignTo(user)">
      {{user.email}}
    </mat-list-option>
  </mat-selection-list>
</nz-drawer>

<nz-modal [(nzVisible)]="isContactDrawerVisible" nzTitle="Add Contact" (nzOnCancel)="hideContactDrawer()"
  (nzOnOk)="isContactDrawerVisible = false;" [nzStyle]="{ top: '200px' }" [nzFooter]="contactModalFooter">
  <form nz-form [formGroup]="contactForm">
    <mat-form-field class="example-full-width">
      <mat-label nzRequired nzFor="note">Name</mat-label>

      <input id="label" type="text" matInput formControlName="label" />

    </mat-form-field>

    <mat-form-field class="example-full-width">
      <mat-label nzRequired nzFor="note">Email / Mobile</mat-label>
      <input id="value" type="text" matInput formControlName="value" />
    </mat-form-field>

      <mat-label>Type of Contact</mat-label>
      <mat-select formControlName="category">
        <mat-option value="mobile">Mobile</mat-option>
        <mat-option value="email">Email</mat-option>
      </mat-select>


    <!-- </mat-form-field> -->
  </form>
  <ng-template #contactModalFooter>
    <button mat-flat-button (click)="submitContactForm(false)">Save</button>
    <button mat-flat-button (click)="submitContactForm(true)">Add Another</button>
  </ng-template>
</nz-modal>