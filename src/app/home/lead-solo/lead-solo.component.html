<nz-content class="parent">
  <div class="top">
    <nz-select nzMode="default" nzPlaceHolder="Inserted are removed" [(ngModel)]="selectedCampaign"
      (ngModelChange)="handleCampaignChange($event);">
      <nz-option *ngFor="let campaign of campaignList" [nzLabel]="campaign.campaignName" [nzValue]="campaign._id">
      </nz-option>
    </nz-select>

    <a nz-button nzType="link" (click)="fetchNextLead()">Fetch Lead</a>
    <a nz-button nzType="link" (click)="openFilterDrawer()">Add Filters</a>
    <ng-container *ngIf="leadFilter">
      <nz-tag *ngFor="let key of objectkeys(leadFilter);" nzMode='closeable' (nzOnClose)="handleTagRemoval(key)" [nzColor]="'magenta'">
        {{typeDict[key].label}} : {{typeDict[key].type === 'date' ? ((leadFilter[key][0]|date)+" to "+(leadFilter[key][1]|date)): leadFilter[key]}}
      </nz-tag>
    </ng-container>
  </div>

  <nz-page-header class="site-page-header" nzBackIcon *ngIf="selectedLead">
    <nz-page-header-title>{{selectedLead.firstName}}</nz-page-header-title>
    <nz-page-header-subtitle>{{selectedLead.lastName}}</nz-page-header-subtitle>
    <nz-page-header-extra>
      <div style="height: 150px; width: 95vw; overflow-y: scroll; padding: 10px; margin-bottom: 20px">
        <nz-timeline>
          <nz-timeline-item nzColor="green" *ngFor="let h of selectedLead?.history.slice().reverse()">
            <p>Created at {{h.createdAt | date:"medium"}} <br><span *ngIf="h.leadStatus">, with lead status <span style="background-color: cornsilk;">{{h.leadStatus}}</span></span></p>
          </nz-timeline-item>
        </nz-timeline>
      </div>
      <button nz-button nzType="secondary" (click)="showLeadDetails()">
        {{isLeadEditMode ? 'Hide': 'Show More'}}
      </button>
      <button nz-button nzType="secondary" (click)="showEmailModal()">Email</button>
    </nz-page-header-extra>
    <nz-page-header-content>
      <div class="content">
        <div class="main">
          <nz-descriptions nzBordered=true>
            <ng-container *ngFor="let leadKey of objectkeys(selectedLead)">
              <ng-container *ngIf="isLeadEditMode">
                <nz-descriptions-item *ngIf="typeDict[leadKey] && isLeadEditMode" [nzTitle]="typeDict[leadKey].label">
                  <ng-container [ngSwitch]="typeDict[leadKey].type">
                    <ng-container *ngSwitchCase="'date'">
                      <nz-date-picker [nzMode]="dateMode" [(ngModel)]="selectedLead[leadKey]"
                        [nzDisabled]="isDisabled(leadKey)" nzShowTime (nzOnOpenChange)="handleDateOpenChange($event)"
                        (nzOnPanelChange)="handleDatePanelChange($event)">
                      </nz-date-picker>
                    </ng-container>

                    <ng-container *ngSwitchCase="'number'">
                      <input nz-input placeholder="Basic usage" [(ngModel)]="selectedLead[leadKey]" />
                    </ng-container>

                    <ng-container *ngSwitchCase="'string'">
                      <input nz-input placeholder="Basic usage" [(ngModel)]="selectedLead[leadKey]"
                        [disabled]="isDisabled(leadKey)" />
                    </ng-container>

                    <!-- <ng-container *ngSwitchCase="'tel'">
                      <a nz-button nzType="primary" href="tel:{{selectedLead[leadKey]}}">{{selectedLead[leadKey]}}</a>
                    </ng-container> -->

                    <ng-container *ngSwitchCase="'select'">
                      <nz-select nzMode="default" [(ngModel)]="selectedLead[leadKey]">
                        <nz-option *ngFor="let option of typeDict[leadKey].options" [nzLabel]="option"
                          [nzValue]="option">
                        </nz-option>
                      </nz-select>
                    </ng-container>
                  </ng-container>
                </nz-descriptions-item>
              </ng-container>
            </ng-container>

            <!-- all fields that have to be shown in level 1 can be shown in this iteration -->
            <ng-container *ngFor="let leadKey of objectkeys(selectedLead)">
              <nz-descriptions-item [nzTitle]="typeDict[leadKey].label" *ngIf="typeDict[leadKey] && (typeDict[leadKey].type === 'tel' || leadKey === 'leadStatus' || leadKey === 'followUp')">
                <ng-container [ngSwitch]="typeDict[leadKey].type">

                  <ng-container *ngSwitchCase="'date'">
                    <nz-date-picker [nzMode]="dateMode" [(ngModel)]="selectedLead[leadKey]"
                      [nzDisabled]="isDisabled(leadKey)" nzShowTime (nzOnOpenChange)="handleDateOpenChange($event)"
                      (nzOnPanelChange)="handleDatePanelChange($event)">
                    </nz-date-picker>
                  </ng-container>

                  <ng-container *ngSwitchCase="'number'">
                    <input nz-input placeholder="Basic usage" [(ngModel)]="selectedLead[leadKey]" />
                  </ng-container>

                  <ng-container *ngSwitchCase="'string'">
                    <input nz-input placeholder="Basic usage" [(ngModel)]="selectedLead[leadKey]"
                      [disabled]="isDisabled(leadKey)" />
                  </ng-container>

                  <ng-container *ngSwitchCase="'tel'">
                    <a nz-button nzType="primary" href="tel:{{selectedLead[leadKey]}}">{{selectedLead[leadKey]}}</a>
                  </ng-container>

                  <ng-container *ngSwitchCase="'select'">
                    <nz-select nzMode="default" [(ngModel)]="selectedLead[leadKey]">
                      <nz-option *ngFor="let option of typeDict[leadKey].options" [nzLabel]="option"
                        [nzValue]="option">
                      </nz-option>
                    </nz-select>
                  </ng-container>
                </ng-container>
              </nz-descriptions-item>
            </ng-container>
            <!-- level 1 ends here -->

            <nz-descriptions-item nzTitle="Disposition">
              <nz-tree [nzData]="callDispositions" nzBlockNode nzShowLine
                (nzClick)="handleDispositionTreeEvent($event)">
              </nz-tree>
            </nz-descriptions-item>

            <nz-descriptions-item nzTitle="Remark" nzSpan=2>
              <nz-input-group class="ant-input-affix-wrapper-textarea-with-clear-btn">
                <textarea nz-input [(ngModel)]="selectedLead['remark']"
                  placeholder="textarea with clear icon"></textarea>
              </nz-input-group>
            </nz-descriptions-item>
          </nz-descriptions>

          <nz-button-group style="margin-top: 5px;">
            <button nzType="danger" nz-button nzSize="default"
            (click)="showReassignmentDrawer()">Reassign</button>
  
            <button nzType="primary" nz-button nzSize="default"
              (click)="handleLeadSubmission(selectedLead, false)">Save</button>
  
            <button nzType="primary" nz-button nzSize="default"
              (click)="handleLeadSubmission(selectedLead, true)">Save & Next</button>
          </nz-button-group>
        </div>
      </div>
    </nz-page-header-content>
    <nz-page-header-footer style="background-color: whitesmoke; padding-left: 10px; padding-right: 10px;">
      <h5>History</h5>
      <!--  -->
    </nz-page-header-footer>
  </nz-page-header>

  <!-- form will adjust according to the modal size so let everything be at 24 grid size -->
  <nz-modal [(nzVisible)]="isVisible" (nzOnCancel)="handleCancel()" (nzOnOk)="handleOk()" #emailModal>
    <form nz-form [formGroup]="emailForm" nzLayout="vertical">
      <nz-form-item>
        <nz-form-label [nzSm]="24" [nzXs]="24" nzRequired>Search By Email Subject</nz-form-label>
        <input placeholder="Email Subject" nz-input [formControl]="etFormControl" [nzAutocomplete]="autob" />
        <nz-autocomplete #autob (selectionChange)="populateEmailModal($event)">
          <nz-auto-option *ngFor="let et of emailTemplates" [nzValue]="et" [nzLabel]="et.subject">
            {{ et.subject }}
          </nz-auto-option>
        </nz-autocomplete>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSm]="24" [nzXs]="24" nzRequired>Subject</nz-form-label>
        <nz-form-control [nzSm]="24" [nzXs]="24">
          <input nz-input placeholder="Write the subject of email" formControlName="subject" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSm]="24" [nzXs]="24" nzRequired>Body</nz-form-label>
        <nz-form-control [nzSm]="24" [nzXs]="24">
          <textarea nz-input placeholder="Controlled autosize" [nzAutosize]="{ minRows: 3, maxRows: 5 }"
            formControlName="content"></textarea>
        </nz-form-control>
      </nz-form-item>
      <nz-form-item>
        <nz-form-label [nzSm]="24" [nzXs]="24" nzRequired>Attachments</nz-form-label>
        <nz-form-control [nzSm]="24" [nzXs]="24">
          <nz-select [nzMaxTagCount]="3" [nzMaxTagPlaceholder]="tagPlaceHolder" nzMode="multiple"
            nzPlaceHolder="Please select attachments from the dropdown" formControlName="attachments">
            <nz-option *ngFor="let attachment of attachments" [nzLabel]="attachment.fileName" [nzValue]="attachment">
            </nz-option>
          </nz-select>
          <ng-template #tagPlaceHolder let-selectedList> and {{ selectedList.length }} more selected </ng-template>
        </nz-form-control>
      </nz-form-item>
    </form>
  </nz-modal>
</nz-content>


<nz-drawer [nzClosable]="true" [nzVisible]="showFilterDrawer" [nzPlacement]="'right'" nzTitle="Lead Filters"
  (nzOnClose)="closeFilterDrawer()">
  <ng-container *ngIf="typeDict">
    <ng-container *ngFor="let key of objectkeys(typeDict)">
      <nz-descriptions>
        <nz-descriptions-item *ngIf="typeDict[key]" [nzTitle]="typeDict[key].label">
          <ng-container [ngSwitch]="typeDict[key].type">
            <ng-container *ngSwitchCase="'date'">
              <nz-range-picker [nzMode]="dateMode" [(ngModel)]="leadFilter[key]"
                (nzOnOpenChange)="handleDateOpenChange($event)"
                (nzOnPanelChange)="handleDatePanelChange($event)">
              </nz-range-picker>
            </ng-container>

            <ng-container *ngSwitchCase="'number'">
              <input nz-input placeholder="Basic usage" [(ngModel)]="leadFilter[key]" />
            </ng-container>

            <ng-container *ngSwitchCase="'string'">
              <input nz-input placeholder="Basic usage" [(ngModel)]="leadFilter[key]"/>
            </ng-container>

            <ng-container *ngSwitchCase="'tel'">
              <input nz-input [(ngModel)]="leadFilter[key]"/>
            </ng-container>

            <ng-container *ngSwitchCase="'select'">
              <nz-select nzMode="default" [(ngModel)]="leadFilter[key]">
                <nz-option *ngFor="let option of typeDict[key].options" [nzLabel]="option" [nzValue]="option">
                </nz-option>
              </nz-select>
            </ng-container>
          </ng-container>
        </nz-descriptions-item>
      </nz-descriptions>
    </ng-container>
    <button nz-button (click)="printFilters()">print filters</button>
  </ng-container>
</nz-drawer>


<!-- user reassignment drawer -->
<nz-drawer [nzClosable]="false" [nzVisible]="isReassignmentDrawerVisible" nzPlacement="bottom" nzHeight="80vh" (nzOnClose)="closeReassignmentDrawer()">
  <ul nz-list [nzDataSource]="usersForReassignment" nzSize="small">
    <nz-list-header><h2>Reassign handler</h2></nz-list-header>
    <li nz-list-item *ngFor="let user of usersForReassignment" nzNoFlex>
      <ul nz-list-item-actions>
        <nz-list-item-action>
          <a>Select</a>
        </nz-list-item-action>
      </ul>
      {{ user.email }}
    </li>
  </ul>
</nz-drawer>